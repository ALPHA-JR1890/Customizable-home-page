<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home Page</title>
    <link rel="icon" type="image/png" href="ALPHA_works_logo.png">
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { 
            margin: 0; 
            padding: 0; 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            background: #eaeaea;
            background-size: cover; 
            background-position: center; 
            background-repeat: no-repeat; 
            transition: background-image 0.4s; 
            font-family: 'Quicksand', Arial, sans-serif;
        }
        #bio-link-sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 200px;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: transparent;
            z-index: 900;
        }
        iframe.bio-link {
            border: none;
            width: 100%;
            height: 100%;
            display: block;
            flex: 1;
        }
        #countdown { position: fixed; top: 20px; right: 20px; background-color: #f0f8ff; border: 2px solid #3498db;
        border-radius: 15px; padding: 10px 20px; font-size: 14px; color: #333;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); z-index: 1000; text-align: center;}
        #things-to-do { position: fixed; top: 80px; right: 20px; width: 200px; height: 200px; background-color: #fff;
        border: 2px solid #3498db; border-radius: 10px; padding: 10px;
        font-size: 14px; color: #333; box-shadow: 0 4px 6px rgba(0,0,0,0.1); resize: none; z-index: 1000;}
        #event-countdowns { position: fixed; bottom: 20px; right: 20px; width: 250px; background-color: #f8f9fa;
        border: 2px solid #e67e22; border-radius: 15px; padding: 16px 18px; font-size: 15px; color: #333; box-shadow: 0 4px 6px rgba(0,0,0,0.08); z-index: 1000;}
        #event-countdowns h3 { margin: 0 0 10px 0; font-size: 16px; color: #e67e22; cursor: pointer; transition: background 0.2s; user-select:none;}
        #event-countdowns h3:hover { background: #ffe5d1; border-radius: 8px;}
        #event-countdowns ul { list-style-type: none; padding-left: 0; margin: 0;}
        #event-countdowns li { margin-bottom: 8px;}
        /* drop-down bar styles */
        .dropdown { position: absolute; right: 18px; bottom: calc(100% + 8px); background: #fff; border: 1px solid #ddd; border-radius: 10px; box-shadow: 0 6px 18px rgba(0,0,0,0.12); min-width: 220px; overflow: hidden; z-index: 1200; }
        .dropdown-item { padding: 10px 12px; cursor: pointer; border-bottom: 1px solid #f1f1f1; color:#333; background: #fff; text-align:left; }
        .dropdown-item:last-child { border-bottom: none; }
        .dropdown-item:hover { background: #f6f9ff; color: #000; }
        .dropdown-title { font-weight:700; padding:8px 12px; border-bottom:1px solid #eee; background:#fafafa; color:#e67e22; }
        /* popups/modal styles (shared for larger dialogs) */
        .overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5);
          display: flex; align-items: center; justify-content: center; z-index: 3000; }
        .modal { background: #fff; padding: 22px 30px 18px 30px; border-radius: 18px;
          box-shadow: 0 4px 24px rgba(0,0,0,0.18); text-align: center; min-width: 280px; max-width: 92%; }
        .modal input[type="text"], .modal select, .modal input[type="date"] { width: 95%; padding: 8px; border: 1.5px solid #ccc;
          border-radius: 8px; font-size: 15px; margin-bottom: 14px;}
        .modal button { background: #3498db; border: none; color: white; padding: 8px 24px;
          border-radius: 8px; font-size: 15px; cursor: pointer; margin-right: 8px;}
        .modal button.danger { background: #e74c3c; }
        .modal .small { padding:6px 12px; font-size:13px; }
        .modal .muted { color:#666; font-size:13px; margin-top:6px;}
        .modal .row { display:flex; gap:8px; justify-content:center; flex-wrap:wrap; margin-top:8px; }
        /* manage events list */
        #manage-events-list { list-style-type: none; padding: 0; margin: 8px 0 0 0; max-height: 240px; overflow:auto; text-align:left; }
        #manage-events-list li { display:flex; justify-content:space-between; align-items:center; padding:6px 8px; border-bottom:1px solid #eee; }

        /* preview styles for background chooser */
        #bgPreview { max-width: 220px; max-height: 120px; border-radius: 8px; margin: 8px auto 0 auto; display: none; object-fit: cover; border:1px solid #eee; }
    </style>
</head>
<body>
    <!-- Welcome popup on load -->
    <div id="welcomePopup" class="overlay" style="display:none;">
        <div id="welcomePopupContent" class="modal">
            <h3>Welcome!</h3>
            <div style="font-size:16px; color:#333; margin:10px 0;">
                Click <strong>Upcoming Events</strong> at the bottom right to open the menu.<br>
                (Change background, set birthday, add/manage custom events)
            </div>
            <div class="row">
                <button id="welcomeClose">OK</button>
            </div>
        </div>
    </div>

    <!-- Manage events popup (lists custom events with delete) -->
    <div id="manageEventsPopup" class="overlay" style="display:none;">
        <div id="manageEventsPopupContent" class="modal">
            <h3>Manage Events</h3>
            <div id="manageEventsContainer" style="margin-top:10px;">
                <ul id="manage-events-list"></ul>
                <div id="no-custom-events" class="muted" style="display:none;">No custom events saved.</div>
            </div>
            <div class="row" style="margin-top:12px;">
                <button id="manageEventsClose" class="small">Close</button>
            </div>
        </div>
    </div>

    <!-- Popup for choosing background: upload or link -->
    <div id="bgPopup" class="overlay" style="display:none;">
        <div id="bgPopupContent" class="modal">
            <h3>Choose Background Image</h3>

            <!-- Upload -->
            <div style="margin-top:6px; text-align:left;">
                <div style="font-weight:600; margin-bottom:6px;">Upload image</div>
                <input type="file" id="bgFileInput" accept="image/*" style="display:none;">
                <div class="row">
                    <button id="bgUploadBtn" class="small">Upload Image</button>
                    <div class="muted" style="align-self:center; font-size:13px;">(PNG, JPG, GIF)</div>
                </div>
                <img id="bgPreview" alt="preview"/>
            </div>

            <hr style="margin:12px 0; border:none; border-top:1px solid #f0f0f0; width:90%;">

            <!-- Link -->
            <div style="margin-top:6px; text-align:left;">
                <div style="font-weight:600; margin-bottom:6px;">Or use image link</div>
                <input type="text" id="bgUrlInput" placeholder="Enter image link here..." />
                <div class="row">
                    <button id="bgUrlSet">Set Link</button>
                    <button id="bgUrlCancel" class="danger">Cancel</button>
                </div>
                <div id="bgUrlError" style="color: red; font-size:12px; margin-top:10px;"></div>
            </div>

            <div style="margin-top:10px; font-size:12px; color:#666;">Note: Uploaded images are stored locally in your browser (localStorage). Very large images may exceed storage limits.</div>
        </div>
    </div>

    <!-- Popup for entering birthday MONTH and DAY only -->
    <div id="birthdayPopup" class="overlay" style="display:none;">
        <div id="birthdayPopupContent" class="modal">
            <h3>Enter Your Birthday</h3>
            <select id="monthInput">
                <option value="">Month</option>
                <option value="1">January</option>
                <option value="2">February</option>
                <option value="3">March</option>
                <option value="4">April</option>
                <option value="5">May</option>
                <option value="6">June</option>
                <option value="7">July</option>
                <option value="8">August</option>
                <option value="9">September</option>
                <option value="10">October</option>
                <option value="11">November</option>
                <option value="12">December</option>
            </select>
            <select id="dayInput">
                <option value="">Day</option>
            </select>
            <div class="row">
                <button id="birthdaySet">Set</button>
                <button id="birthdayCancel" class="danger">Skip</button>
            </div>
            <div id="birthdayError" style="color: red; font-size:12px; margin-top:10px;"></div>
        </div>
    </div>

    <!-- Popup for adding a custom event -->
    <div id="eventPopup" class="overlay" style="display:none;">
        <div id="eventPopupContent" class="modal">
            <h3>Add Custom Event</h3>
            <input type="text" id="customEventName" placeholder="Event name"/>
            <input type="date" id="customEventDate"/>
            <div class="row">
                <button id="eventAdd">Add Event</button>
                <button id="eventCancel" class="danger">Cancel</button>
            </div>
            <div id="eventError" style="color: red; font-size:12px; margin-top:10px;"></div>
        </div>
    </div>

    <!-- Live Date/Time -->
    <div id="countdown">Loading...</div>
    <textarea id="things-to-do" placeholder="Things to do..."></textarea>
    <!-- SIDEBAR: Make bio.link go all the way down -->
    <div id="bio-link-sidebar">
        <iframe class="bio-link" id="bio-link-iframe" src="https://bio.link/alpha_jr" title="Bio Link"></iframe>
    </div>

    <div id="event-countdowns">
        <h3 id="eventMenuButton" title="Click for options">Upcoming Events â–¼</h3>
        <!-- Dropdown menu (appears above this box) -->
        <div id="settingsDropdown" class="dropdown" style="display:none;">
            <div class="dropdown-title">Settings</div>
            <div class="dropdown-item" id="dd-change-bg">Change Background</div>
            <div class="dropdown-item" id="dd-set-birthday">Set Birthday</div>
            <div class="dropdown-item" id="dd-add-event">Add Event</div>
            <div class="dropdown-item" id="dd-manage-events">Manage Events</div>
        </div>
        <ul id="holiday-events"></ul>
    </div>

    <script>
        // Restore background from localStorage on page load
        (function() {
            const bgImg = localStorage.getItem('customBgImg');
            if(bgImg) {
                document.body.style.backgroundImage = `url('${bgImg}')`;
            }
        })();

        // --- HOLIDAYS HELPERS (fixed) ---
        function nthWeekdayOfMonth(year, month, weekday, n) {
            let date = new Date(year, month, 1);
            let count = 0;
            while (date.getMonth() === month) {
                if (date.getDay() === weekday) {
                    count++;
                    if (count === n) return new Date(date);
                }
                date.setDate(date.getDate() + 1);
            }
            return null;
        }
        function lastWeekdayOfMonth(year, month, weekday) {
            let date = new Date(year, month + 1, 0);
            while (date.getDay() !== weekday) {
                date.setDate(date.getDate() - 1);
            }
            return new Date(date);
        }
        function easter(year) {
            var a = year % 19;
            var b = Math.floor(year / 100);
            var c = year % 100;
            var d = Math.floor(b / 4);
            var e = b % 4;
            var f = Math.floor((b + 8) / 25);
            var g = Math.floor((b - f + 1) / 3);
            var h = (19 * a + b - d - g + 15) % 30;
            var i = Math.floor(c / 4);
            var k = c % 4;
            var l = (32 + 2 * e + 2 * i - h - k) % 7;
            var m = Math.floor((a + 11 * h + 22 * l) / 451);
            var month = Math.floor((h + l - 7 * m + 114) / 31) - 1;
            var day = ((h + l - 7 * m + 114) % 31) + 1;
            return new Date(year, month, day);
        }

        function mlkDay(year) { return nthWeekdayOfMonth(year, 0, 1, 3); } // third Monday of Jan
        function presidentsDay(year) { return nthWeekdayOfMonth(year, 1, 1, 3); } // third Monday of Feb
        function memorialDay(year) { return lastWeekdayOfMonth(year, 4, 1); } // last Monday of May
        function laborDay(year) { return nthWeekdayOfMonth(year, 8, 1, 1); } // first Monday of Sep
        function thanksgiving(year) { return nthWeekdayOfMonth(year, 10, 4, 4); } // fourth Thursday of Nov

        function getUSHolidays(year) {
            return [
                { name: "ðŸŽ‰ New Year's Day", date: new Date(year, 0, 1) },
                { name: "ðŸ›‘ Martin Luther King Jr Day", date: mlkDay(year) },
                { name: "ðŸ‡ºðŸ‡¸ Presidents Day", date: presidentsDay(year) },
                { name: "ðŸ° Easter", date: easter(year) },
                { name: "ðŸŒ· Memorial Day", date: memorialDay(year) },
                { name: "ðŸŽ† Independence Day", date: new Date(year, 6, 4) },
                { name: "ðŸ Labor Day", date: laborDay(year) },
                { name: "ðŸ¦ƒ Thanksgiving", date: thanksgiving(year) },
                { name: "ðŸŽ„ Christmas Day", date: new Date(year, 11, 25) }
            ].filter(h => h.date instanceof Date && !isNaN(h.date.getTime()));
        }

        function findNextHoliday(now) {
            const thisYear = now.getFullYear();
            let holidays = getUSHolidays(thisYear).concat(getUSHolidays(thisYear + 1));
            holidays.sort((a, b) => a.date - b.date);
            for (let i = 0; i < holidays.length; i++) {
                if (holidays[i].date > now) return holidays[i];
            }
            return null;
        }

        const dayInput = document.getElementById('dayInput');
        for(let d=1; d<=31; d++){
            const opt = document.createElement('option');
            opt.value = d;
            opt.textContent = d;
            dayInput.appendChild(opt);
        }

        const thingsToDoBox = document.getElementById('things-to-do');
        thingsToDoBox.value = localStorage.getItem('thingsToDo') || '';
        thingsToDoBox.addEventListener('input', () => {
            localStorage.setItem('thingsToDo', thingsToDoBox.value);
        });

        function getUserBirthday() {
            let stored = localStorage.getItem('userBirthdayMMDD');
            if (stored) {
                let parts = stored.split('-');
                let month = parseInt(parts[0]);
                let day = parseInt(parts[1]);
                if(!isNaN(month) && !isNaN(day)) {
                    return {month, day};
                }
            }
            return null;
        }

        // -- CUSTOM EVENT STORAGE (in localStorage) --
        function getCustomEvents() {
            try {
                const arr = JSON.parse(localStorage.getItem('customEvents') || '[]');
                const today = new Date();
                today.setHours(0,0,0,0);
                const filtered = arr.filter(ev => {
                    const evDate = new Date(ev.date + 'T00:00:00');
                    return evDate >= today;
                });
                if (filtered.length !== arr.length) localStorage.setItem('customEvents', JSON.stringify(filtered));
                return filtered;
            } catch { return []; }
        }
        function addCustomEvent(name, dateStr) {
            let evts = getCustomEvents();
            evts.push({ name, date: dateStr });
            localStorage.setItem('customEvents', JSON.stringify(evts));
        }
        function removeCustomEvent(idx) {
            let evts = getCustomEvents();
            evts.splice(idx, 1);
            localStorage.setItem('customEvents', JSON.stringify(evts));
            updateHolidayCountdowns();
        }

        function getCountdownText(targetDate, currentDate = null) {
            const now = currentDate || new Date();
            let diff = targetDate - now;
            if (diff < 0) return "Passed!";
            let days = Math.floor(diff / (1000 * 60 * 60 * 24));
            let hours = Math.floor((diff / (1000 * 60 * 60)) % 24);
            let mins = Math.floor((diff / (1000 * 60)) % 60);
            let secs = Math.floor((diff / 1000) % 60);
            return `${days} days, ${hours} hours, ${mins} mins, ${secs} secs`;
        }

        function updateHolidayCountdowns() {
            const eventsElem = document.getElementById('holiday-events');
            eventsElem.innerHTML = "";
            const now = new Date();

            const nextHoliday = findNextHoliday(now);
            if (nextHoliday) {
                let countdown = getCountdownText(nextHoliday.date, now);
                let li = document.createElement('li');
                li.innerHTML = `<strong>${nextHoliday.name} :</strong> ${countdown}`;
                eventsElem.appendChild(li);
            } else {
                let li = document.createElement('li');
                li.textContent = "No upcoming holidays found.";
                eventsElem.appendChild(li);
            }

            let bday = getUserBirthday();
            if (bday) {
                let thisMonth = now.getMonth() + 1;
                let today = now.getDate();
                let bYear = (thisMonth > bday.month) || (thisMonth === bday.month && today > bday.day) ? now.getFullYear() + 1 : now.getFullYear();
                let birthdayDate = new Date(bYear, bday.month - 1, bday.day, 0, 0, 0);
                let countdown = getCountdownText(birthdayDate, now);
                let li = document.createElement('li');
                li.innerHTML = `<strong>ðŸŽ‚ My Birthday :</strong> ${countdown}`;
                eventsElem.appendChild(li);
            }

            const customEvents = getCustomEvents();
            customEvents.forEach((ev, i) => {
                let evDate = new Date(ev.date + 'T00:00:00');
                if (isNaN(evDate.getTime())) return;
                let countdown = getCountdownText(evDate, now);
                let li = document.createElement('li');
                li.innerHTML =
                    `<strong>ðŸ“… ${ev.name} :</strong> ${countdown} <button data-del-idx="${i}" style="margin-left:8px;padding:2px 6px;border-radius:6px;">Delete</button>`;
                eventsElem.appendChild(li);
            });

            eventsElem.querySelectorAll("button[data-del-idx]").forEach(btn => {
                btn.onclick = function() {
                    const idx = parseInt(btn.getAttribute("data-del-idx"));
                    if (!isNaN(idx)) removeCustomEvent(idx);
                };
            });
        }

        setInterval(updateHolidayCountdowns, 1000);
        updateHolidayCountdowns();

        // --- Elements for popups ---
        const bgPopup = document.getElementById('bgPopup');
        const bgFileInput = document.getElementById('bgFileInput');
        const bgUploadBtn = document.getElementById('bgUploadBtn');
        const bgPreview = document.getElementById('bgPreview');
        const bgUrlInput = document.getElementById('bgUrlInput');
        const bgUrlSet = document.getElementById('bgUrlSet');
        const bgUrlCancel = document.getElementById('bgUrlCancel');
        const bgUrlError = document.getElementById('bgUrlError');
        const birthdayPopup = document.getElementById('birthdayPopup');
        const monthInput = document.getElementById('monthInput');
        const birthdaySet = document.getElementById('birthdaySet');
        const birthdayCancel = document.getElementById('birthdayCancel');
        const birthdayError = document.getElementById('birthdayError');
        const eventPopup = document.getElementById('eventPopup');
        const customEventName = document.getElementById('customEventName');
        const customEventDate = document.getElementById('customEventDate');
        const eventAdd = document.getElementById('eventAdd');
        const eventCancel = document.getElementById('eventCancel');
        const eventError = document.getElementById('eventError');

        const manageEventsPopup = document.getElementById('manageEventsPopup');
        const manageEventsClose = document.getElementById('manageEventsClose');
        const manageEventsList = document.getElementById('manage-events-list');
        const noCustomEventsEl = document.getElementById('no-custom-events');

        const settingsDropdown = document.getElementById('settingsDropdown');
        const eventMenuButton = document.getElementById('eventMenuButton');
        const ddChangeBg = document.getElementById('dd-change-bg');
        const ddSetBirthday = document.getElementById('dd-set-birthday');
        const ddAddEvent = document.getElementById('dd-add-event');
        const ddManageEvents = document.getElementById('dd-manage-events');

        // Welcome popup logic
        const welcomePopup = document.getElementById('welcomePopup');
        const welcomeClose = document.getElementById('welcomeClose');
        function showWelcomePopup() { welcomePopup.style.display = "flex"; }
        function hideWelcomePopup() { welcomePopup.style.display = "none"; }
        welcomeClose.addEventListener('click', hideWelcomePopup);

        // Show welcome on load
        window.addEventListener('DOMContentLoaded', () => {
            showWelcomePopup();
        });

        // Generic show/hide helpers
        function showBgPopup(defaultUrl = '') {
            hideDropdown();
            bgUrlInput.value = defaultUrl;
            bgUrlError.textContent = '';
            bgPreview.style.display = 'none';
            bgPreview.src = '';
            bgFileInput.value = '';
            bgPopup.style.display = "flex";
            bgUrlInput.focus();
        }
        function hideBgPopup() { bgPopup.style.display = "none"; }

        function showBirthdayPopup() {
            hideDropdown();
            let raw = localStorage.getItem('userBirthdayMMDD');
            if (raw) {
                let parts = raw.split('-');
                if(parts.length === 2) {
                    monthInput.value = parts[0];
                    dayInput.value = parts[1];
                }
            } else {
                monthInput.value = "";
                dayInput.value = "";
            }
            birthdayError.textContent = '';
            birthdayPopup.style.display = "flex";
            monthInput.focus();
        }
        function hideBirthdayPopup() { birthdayPopup.style.display = "none"; }

        function showEventPopup() {
            hideDropdown();
            customEventName.value = "";
            customEventDate.value = "";
            eventError.textContent = "";
            eventPopup.style.display = "flex";
            customEventName.focus();
        }
        function hideEventPopup() { eventPopup.style.display = "none"; }

        function showManageEventsPopup() {
            hideDropdown();
            const evts = getCustomEvents();
            manageEventsList.innerHTML = "";
            if (!evts.length) {
                noCustomEventsEl.style.display = "block";
            } else {
                noCustomEventsEl.style.display = "none";
                evts.forEach((ev, i) => {
                    const li = document.createElement('li');
                    const left = document.createElement('div');
                    left.textContent = `${ev.name} (${ev.date})`;
                    const right = document.createElement('div');
                    const delBtn = document.createElement('button');
                    delBtn.textContent = "Delete";
                    delBtn.className = "small danger";
                    delBtn.style.padding = "4px 8px";
                    delBtn.onclick = () => {
                        if (confirm(`Delete "${ev.name}"?`)) {
                            removeCustomEvent(i);
                            showManageEventsPopup(); // re-render
                        }
                    };
                    right.appendChild(delBtn);
                    li.appendChild(left);
                    li.appendChild(right);
                    manageEventsList.appendChild(li);
                });
            }
            manageEventsPopup.style.display = "flex";
        }
        function hideManageEventsPopup() { manageEventsPopup.style.display = "none"; }

        // Dropdown toggle/close helpers
        function toggleDropdown() {
            if (settingsDropdown.style.display === "none" || settingsDropdown.style.display === "") {
                settingsDropdown.style.display = "block";
            } else {
                settingsDropdown.style.display = "none";
            }
        }
        function hideDropdown() {
            settingsDropdown.style.display = "none";
        }

        // Bind dropdown actions
        eventMenuButton.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleDropdown();
        });
        ddChangeBg.addEventListener('click', () => showBgPopup(localStorage.getItem('customBgImg') || ''));
        ddSetBirthday.addEventListener('click', () => showBirthdayPopup());
        ddAddEvent.addEventListener('click', () => showEventPopup());
        ddManageEvents.addEventListener('click', () => showManageEventsPopup());

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            let target = e.target;
            if (!settingsDropdown.contains(target) && target !== eventMenuButton) {
                hideDropdown();
            }
        });

        // bg popup: upload flow
        bgUploadBtn.addEventListener('click', () => {
            bgFileInput.click();
        });
        bgFileInput.addEventListener('change', function(e) {
            const file = e.target.files && e.target.files[0];
            bgUrlError.textContent = '';
            if (!file) return;
            if (!file.type.startsWith('image/')) {
                bgUrlError.textContent = 'Please select an image file.';
                return;
            }
            const reader = new FileReader();
            reader.onload = function() {
                const dataUrl = reader.result;
                // preview
                bgPreview.src = dataUrl;
                bgPreview.style.display = 'block';
                try {
                    // attempt to save data URL to localStorage
                    localStorage.setItem('customBgImg', dataUrl);
                    document.body.style.backgroundImage = `url('${dataUrl}')`;
                    // close popup after a short delay so user sees preview
                    setTimeout(hideBgPopup, 600);
                } catch (err) {
                    // storage error (likely quota). Show preview but don't store.
                    bgUrlError.textContent = 'Image too large to save locally. Preview shown but cannot persist.';
                    document.body.style.backgroundImage = `url('${dataUrl}')`;
                    setTimeout(hideBgPopup, 600);
                }
            };
            reader.onerror = function() {
                bgUrlError.textContent = 'Failed to read file.';
            };
            reader.readAsDataURL(file);
        });

        // bg popup: link flow
        bgUrlCancel.addEventListener('click', hideBgPopup);
        bgUrlSet.addEventListener('click', () => {
            let url = bgUrlInput.value.trim();
            bgUrlError.textContent = '';
            if (!url) {
                bgUrlError.textContent = 'Please enter an image link!';
                return;
            }
            if (!/^https?:\/\/.+/.test(url)) {
                bgUrlError.textContent = 'Please enter a valid URL starting with http or https';
                return;
            }
            // quick preview load check (non-blocking). We'll set background immediately.
            const img = new Image();
            img.onload = function() {
                // set preview and save
                bgPreview.src = url;
                bgPreview.style.display = 'block';
                try {
                    localStorage.setItem('customBgImg', url);
                } catch (err) {
                    // ignore quota error for remote url (unlikely)
                }
                document.body.style.backgroundImage = `url('${url}')`;
                hideBgPopup();
            };
            img.onerror = function() {
                bgUrlError.textContent = 'Could not load image from that link. Check URL.';
            };
            img.src = url;
        });
        bgUrlInput.addEventListener('keydown', function(e){
            if(e.key === 'Enter') bgUrlSet.click();
        });

        // birthday handlers
        birthdaySet.addEventListener('click', () => {
            if (!monthInput.value || !dayInput.value) {
                birthdayError.textContent = 'Please select both month and day!';
                return;
            }
            let mmdd = `${monthInput.value}-${dayInput.value}`;
            localStorage.setItem('userBirthdayMMDD', mmdd);
            hideBirthdayPopup();
            updateHolidayCountdowns();
        });
        birthdayCancel.addEventListener('click', () => {
            localStorage.removeItem('userBirthdayMMDD');
            hideBirthdayPopup();
            updateHolidayCountdowns();
        });
        monthInput.addEventListener('keydown', function(e){
            if(e.key === 'Enter') birthdaySet.click();
        });
        dayInput.addEventListener('keydown', function(e){
            if(e.key === 'Enter') birthdaySet.click();
        });

        // event add handlers
        eventAdd.addEventListener('click', function() {
            let name = customEventName.value.trim();
            let dateStr = customEventDate.value;
            if (!name || !dateStr) {
                eventError.textContent = "Please enter both event name and event date!";
                return;
            }
            addCustomEvent(name, dateStr);
            hideEventPopup();
            updateHolidayCountdowns();
        });
        eventCancel.addEventListener('click', function() {
            hideEventPopup();
        });
        customEventName.addEventListener('keydown', function(e) {
            if(e.key === 'Enter') customEventDate.focus();
        });
        customEventDate.addEventListener('keydown', function(e) {
            if(e.key === 'Enter') eventAdd.click();
        });

        manageEventsClose.addEventListener('click', hideManageEventsPopup);

        function startClock() {
            const clockElement = document.getElementById('countdown');
            function updateClock() {
                const now = new Date();
                const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                const formattedDate = now.toLocaleDateString('en-US', dateOptions);
                const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true };
                const formattedTime = now.toLocaleTimeString('en-US', timeOptions);
                clockElement.innerHTML = `${formattedDate}<br>${formattedTime}`;
            }
            setInterval(updateClock, 1000);
            updateClock();
        }
        startClock();

        // Close modal overlays when clicking outside modal content
        document.querySelectorAll('.overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.style.display = 'none';
                }
            });
        });
    </script>
</body>
</html>
